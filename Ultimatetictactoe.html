<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Tic-Tac-Toe | Meta Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .cell { width: 100%; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .mini-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; padding: 4px; background: #e2e8f0; border-radius: 4px; transition: all 0.3s; position: relative; }
        .active-board { background: #fef08a !important; transform: scale(1.02); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 10; }
        
        /* Win Overlays */
        .won-x::after, .won-o::after, .won-tie::after { 
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; 
            font-size: 5rem; font-weight: 900; pointer-events: none; z-index: 20;
        }
        .won-x { background: #fee2e2 !important; }
        .won-x::after { content: 'X'; color: rgba(239, 68, 68, 0.3); }
        .won-o { background: #dbeafe !important; }
        .won-o::after { content: 'O'; color: rgba(59, 130, 246, 0.3); }
        .won-tie { background: #f1f5f9 !important; opacity: 0.8; }
        .won-tie::after { content: '-'; color: rgba(100, 116, 139, 0.3); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <div id="setup-screen" class="fixed inset-0 bg-white z-50 flex items-center justify-center p-6">
        <div class="max-w-md w-full space-y-8 text-center">
            <h1 class="text-5xl font-black text-slate-800 tracking-tighter">ULTIMATE<br><span class="text-indigo-600">TIC-TAC-TOE</span></h1>
            <div class="space-y-4">
                <input type="text" id="player-name" placeholder="Enter your name" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-indigo-500 outline-none text-lg">
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="startGame('cpu')" class="bg-slate-800 text-white py-4 rounded-xl font-bold hover:bg-slate-700 transition">Play vs CPU</button>
                    <button onclick="showInvite()" class="bg-indigo-600 text-white py-4 rounded-xl font-bold hover:bg-indigo-500 transition">Play vs Friend</button>
                </div>
            </div>
        </div>
    </div>

    <div id="invite-screen" class="fixed inset-0 bg-white z-40 hidden flex items-center justify-center p-6">
        <div class="max-w-md w-full text-center space-y-6">
            <h2 class="text-2xl font-bold">Invite a Friend</h2>
            <p class="text-slate-500">Share this link with your friend to start the match:</p>
            <div class="flex gap-2">
                <input type="text" id="invite-link" readonly class="flex-1 px-4 py-2 bg-slate-100 rounded-lg border text-sm">
                <button onclick="copyInvite()" class="bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold">Copy</button>
            </div>
            <button onclick="startGame('pvp')" class="text-indigo-600 font-semibold underline">Done, Start Playing</button>
        </div>
    </div>

    <main id="game-screen" class="max-w-4xl mx-auto p-4 hidden">
        <header class="flex justify-between items-center mb-8">
            <div class="flex gap-4">
                <div class="bg-white p-3 rounded-xl shadow-sm border-b-4 border-red-400">
                    <p id="p1-label" class="text-xs font-bold text-slate-400 uppercase">Player X</p>
                    <p id="score-x" class="text-2xl font-black">0</p>
                </div>
                <div class="bg-white p-3 rounded-xl shadow-sm border-b-4 border-blue-400">
                    <p id="p2-label" class="text-xs font-bold text-slate-400 uppercase">Opponent O</p>
                    <p id="score-o" class="text-2xl font-black">0</p>
                </div>
            </div>
            <div id="turn-indicator" class="text-lg font-bold bg-indigo-100 text-indigo-700 px-6 py-2 rounded-full">
                X's Turn
            </div>
            <button onclick="shareScore()" class="bg-slate-200 p-3 rounded-full hover:bg-slate-300">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M176,144a40,40,0,0,0-31.2,14.92l-36.41-18.2a40.09,40.09,0,0,0,0-21.44l36.41-18.2a40,40,0,1,0-7.17-14.33L101.22,105a40,40,0,1,0,0,46.06l36.41,18.2A40,40,0,1,0,176,144Z"></path></svg>
            </button>
        </header>

        <div id="mega-board" class="grid grid-cols-3 gap-4 bg-slate-300 p-4 rounded-2xl shadow-2xl aspect-square max-w-[600px] mx-auto">
            </div>

        <p id="instructions" class="text-center mt-8 text-slate-500 italic">
            Tip: Your move determines which grid the opponent plays in next!
        </p>
    </main>

    <script>
        let userName = "Player";
        let gameMode = "cpu";
        let currentPlayer = "X";
        let nextRequiredBoard = null; 
        let scores = { X: 0, O: 0 };
        let bigBoardWinners = Array(9).fill(null); // Values: 'X', 'O', 'Tie', or null
        let boardStates = Array(9).fill(null).map(() => Array(9).fill(null));

        function showInvite() {
            const name = document.getElementById('player-name').value || "Friend";
            const link = `${window.location.origin}${window.location.pathname}?invite=${encodeURIComponent(name)}`;
            document.getElementById('invite-link').value = link;
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('invite-screen').classList.remove('hidden');
        }

        function copyInvite() {
            const copyText = document.getElementById("invite-link");
            copyText.select();
            navigator.clipboard.writeText(copyText.value);
            alert("Link copied! Send it to your friend.");
        }

        function startGame(mode) {
            gameMode = mode;
            userName = document.getElementById('player-name').value || "Player X";
            document.getElementById('p1-label').innerText = userName;
            document.getElementById('p2-label').innerText = mode === 'cpu' ? 'CPU (O)' : 'Player O';
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('invite-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            initBoard();
        }

        function initBoard() {
            const container = document.getElementById('mega-board');
            container.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const miniGrid = document.createElement('div');
                miniGrid.id = `mini-${i}`;
                miniGrid.className = 'mini-grid';
                for (let j = 0; j < 9; j++) {
                    const cell = document.createElement('button');
                    cell.className = 'cell bg-white text-xl rounded-sm hover:bg-indigo-50';
                    cell.onclick = () => handleMove(i, j);
                    miniGrid.appendChild(cell);
                }
                container.appendChild(miniGrid);
            }
            updateVisuals();
        }

        function handleMove(boardIdx, cellIdx) {
            if (bigBoardWinners[boardIdx] || boardStates[boardIdx][cellIdx]) return;
            if (nextRequiredBoard !== null && nextRequiredBoard !== boardIdx) return;

            executeMove(boardIdx, cellIdx);

            if (gameMode === 'cpu' && currentPlayer === 'O') {
                setTimeout(makeCPUMove, 600);
            }
        }

        function executeMove(boardIdx, cellIdx) {
            boardStates[boardIdx][cellIdx] = currentPlayer;
            const cell = document.querySelector(`#mini-${boardIdx}`).children[cellIdx];
            cell.innerText = currentPlayer;
            cell.classList.add(currentPlayer === 'X' ? 'text-red-500' : 'text-blue-500');

            // 1. Check Mini-Board Result
            if (checkWin(boardStates[boardIdx])) {
                bigBoardWinners[boardIdx] = currentPlayer;
                document.getElementById(`mini-${boardIdx}`).classList.add(`won-${currentPlayer.toLowerCase()}`);
            } else if (boardStates[boardIdx].every(c => c !== null)) {
                bigBoardWinners[boardIdx] = 'Tie';
                document.getElementById(`mini-${boardIdx}`).classList.add(`won-tie`);
            }

            // 2. Check Mega-Board Result
            if (checkWin(bigBoardWinners)) {
                alert(`ðŸŽŠ ${currentPlayer === 'X' ? userName : 'Opponent'} wins the entire game!`);
                scores[currentPlayer]++;
                resetGame();
                return;
            } else if (bigBoardWinners.every(b => b !== null)) {
                alert("ðŸ¤ It's a Mega-Tie! No one won the large board.");
                resetGame();
                return;
            }

            // 3. Routing Logic
            const targetIsComplete = bigBoardWinners[cellIdx] !== null;
            nextRequiredBoard = targetIsComplete ? null : cellIdx;

            currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
            updateVisuals();
        }

        function makeCPUMove() {
            let bIdx = nextRequiredBoard;
            if (bIdx === null) {
                const openBoards = bigBoardWinners.map((v, i) => v === null ? i : null).filter(v => v !== null);
                bIdx = openBoards[Math.floor(Math.random() * openBoards.length)];
            }
            
            const openCells = boardStates[bIdx].map((v, i) => v === null ? i : null).filter(v => v !== null);
            const cIdx = openCells[Math.floor(Math.random() * openCells.length)];
            executeMove(bIdx, cIdx);
        }

        function checkWin(board) {
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            return wins.some(pattern => {
                const [a, b, c] = pattern;
                // Ensure the cell is not null AND is not a 'Tie' (only X or O can win)
                return board[a] && board[a] !== 'Tie' && board[a] === board[b] && board[a] === board[c];
            });
        }

        function updateVisuals() {
            document.getElementById('turn-indicator').innerText = `${currentPlayer === 'X' ? userName : 'Opponent'}'s Turn`;
            document.getElementById('score-x').innerText = scores.X;
            document.getElementById('score-o').innerText = scores.O;

            for (let i = 0; i < 9; i++) {
                const grid = document.getElementById(`mini-${i}`);
                grid.classList.remove('active-board');
                if (!bigBoardWinners[i] && (nextRequiredBoard === null || nextRequiredBoard === i)) {
                    grid.classList.add('active-board');
                }
            }
        }

        function resetGame() {
            bigBoardWinners = Array(9).fill(null);
            boardStates = Array(9).fill(null).map(() => Array(9).fill(null));
            nextRequiredBoard = null;
            currentPlayer = "X";
            setTimeout(initBoard, 500);
        }

        function shareScore() {
            const text = `Ultimate Tic-Tac-Toe: ${userName} (${scores.X}) vs Opponent (${scores.O})`;
            if (navigator.share) {
                navigator.share({ title: 'Game Score', text: text });
            } else {
                alert("Score copied: " + text);
            }
        }
    </script>
</body>
</html>